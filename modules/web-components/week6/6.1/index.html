<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6.1 MAD9022 | MAD9022</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="Fullstack: Frontend Development Course">
    
    <link rel="preload" href="/w2023/assets/css/0.styles.33e990fb.css" as="style"><link rel="preload" href="/w2023/assets/js/app.49733bfc.js" as="script"><link rel="preload" href="/w2023/assets/js/2.e00fc094.js" as="script"><link rel="preload" href="/w2023/assets/js/45.90d16594.js" as="script"><link rel="preload" href="/w2023/assets/js/9.b21c66c5.js" as="script"><link rel="preload" href="/w2023/assets/js/11.92cefe25.js" as="script"><link rel="prefetch" href="/w2023/assets/js/10.41910312.js"><link rel="prefetch" href="/w2023/assets/js/12.b4bafa0d.js"><link rel="prefetch" href="/w2023/assets/js/13.ba803485.js"><link rel="prefetch" href="/w2023/assets/js/14.1e383464.js"><link rel="prefetch" href="/w2023/assets/js/15.bacbf527.js"><link rel="prefetch" href="/w2023/assets/js/16.e7714ee9.js"><link rel="prefetch" href="/w2023/assets/js/17.3aada0e0.js"><link rel="prefetch" href="/w2023/assets/js/18.96ead32f.js"><link rel="prefetch" href="/w2023/assets/js/19.4e5249bf.js"><link rel="prefetch" href="/w2023/assets/js/20.5dee1097.js"><link rel="prefetch" href="/w2023/assets/js/21.ec6718fa.js"><link rel="prefetch" href="/w2023/assets/js/22.fa6508dc.js"><link rel="prefetch" href="/w2023/assets/js/23.9a4c47c6.js"><link rel="prefetch" href="/w2023/assets/js/24.b2a84dff.js"><link rel="prefetch" href="/w2023/assets/js/25.85a09377.js"><link rel="prefetch" href="/w2023/assets/js/26.f1eb484c.js"><link rel="prefetch" href="/w2023/assets/js/27.25c44fa0.js"><link rel="prefetch" href="/w2023/assets/js/28.51999317.js"><link rel="prefetch" href="/w2023/assets/js/29.65075bca.js"><link rel="prefetch" href="/w2023/assets/js/3.1ae5a99d.js"><link rel="prefetch" href="/w2023/assets/js/30.5d45979f.js"><link rel="prefetch" href="/w2023/assets/js/31.22b62fdb.js"><link rel="prefetch" href="/w2023/assets/js/32.bd051bb4.js"><link rel="prefetch" href="/w2023/assets/js/33.56eaee4e.js"><link rel="prefetch" href="/w2023/assets/js/34.62593793.js"><link rel="prefetch" href="/w2023/assets/js/35.4456d2ac.js"><link rel="prefetch" href="/w2023/assets/js/36.2f2d8a40.js"><link rel="prefetch" href="/w2023/assets/js/37.5e082827.js"><link rel="prefetch" href="/w2023/assets/js/38.71855794.js"><link rel="prefetch" href="/w2023/assets/js/39.485f42ce.js"><link rel="prefetch" href="/w2023/assets/js/4.64bbff17.js"><link rel="prefetch" href="/w2023/assets/js/40.8e5ddf6e.js"><link rel="prefetch" href="/w2023/assets/js/41.fea3541d.js"><link rel="prefetch" href="/w2023/assets/js/42.d3040fe8.js"><link rel="prefetch" href="/w2023/assets/js/43.0e1d1cc9.js"><link rel="prefetch" href="/w2023/assets/js/44.fbbee689.js"><link rel="prefetch" href="/w2023/assets/js/46.fa7c6a52.js"><link rel="prefetch" href="/w2023/assets/js/47.3fb6e90a.js"><link rel="prefetch" href="/w2023/assets/js/48.2c7860fe.js"><link rel="prefetch" href="/w2023/assets/js/5.8ce5e2d0.js"><link rel="prefetch" href="/w2023/assets/js/6.a0bc34a0.js"><link rel="prefetch" href="/w2023/assets/js/7.0dc96026.js"><link rel="prefetch" href="/w2023/assets/js/8.c36795df.js">
    <link rel="stylesheet" href="/w2023/assets/css/0.styles.33e990fb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2023/" class="home-link router-link-active"><!----> <span class="site-name">MAD9022</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hybrid</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Web Components &amp; PWAs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2023/modules/web-components/week1/1.1/" class="sidebar-link">1.1: Web Components</a></li><li><a href="/w2023/modules/web-components/week2/2.1/" class="sidebar-link">2.1: Component Methods</a></li><li><a href="/w2023/modules/web-components/week2/2.2/" class="sidebar-link">2.2: Styling Components</a></li><li><a href="/w2023/modules/web-components/week3/3.1/" class="sidebar-link">3.1: Web Storage, Cookies, &amp; Cache</a></li><li><a href="/w2023/modules/web-components/week3/3.2/" class="sidebar-link">3.2: Cache, Files &amp; Responses</a></li><li><a href="/w2023/modules/web-components/week4/4.1/" class="sidebar-link">4.1: Intro to Workers</a></li><li><a href="/w2023/modules/web-components/week4/4.2/" class="sidebar-link">4.2: Service Workers</a></li><li><a href="/w2023/modules/web-components/week5/5.1/" class="sidebar-link">5.1: Intro to PWA</a></li><li><a href="/w2023/modules/web-components/week5/5.2/" class="sidebar-link">5.2: PWA Audits, Offline, &amp; Async Methods</a></li><li><a href="/w2023/modules/web-components/week6/6.1/" aria-current="page" class="active sidebar-link">6.1: Messaging &amp; Screen APIs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#messaging" class="sidebar-link">Messaging</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#broadcast-messaging" class="sidebar-link">Broadcast Messaging</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#channel-messaging" class="sidebar-link">Channel Messaging</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#client-messaging" class="sidebar-link">Client Messaging</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#page-visibility-api" class="sidebar-link">Page Visibility API</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#fullscreen-api" class="sidebar-link">FullScreen API</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#screenorientation-api" class="sidebar-link">ScreenOrientation API</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/web-components/week6/6.1/#todo-this-week" class="sidebar-link">ToDo This Week</a></li></ul></li><li><a href="/w2023/modules/web-components/week6/6.2/" class="sidebar-link">6.2: PWA Project and Review</a></li><li><a href="/w2023/modules/web-components/week7/7.1/" class="sidebar-link">7.1: PWA Project</a></li></ul></section></li><li><a href="/w2023/modules/reading/" class="sidebar-link">Reading Week</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deliverables</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><header><div class="section-title blue">
    PWA
  </div> <h1>6.1 MAD9022</h1></header> <h2 id="messaging"><a href="#messaging" class="header-anchor">#</a> Messaging</h2> <p>To be able to change the functionality of your Service Worker depending on whether or not the browser is online or offline, we need to first test for the online status and then pass that information
between the webpage and the Service Worker.</p> <p>Refer back to the <a href="/w2023/modules/web-components/week5/5.2/#offline-first">notes about online and offline events in Module 5.2</a>.</p> <p>Once you have a status for the webpage being online or offline (usually a boolean variable), then you need to pass a message from the page to the Service Worker with that status.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//initial status when your page loads</span>
<span class="token keyword">const</span> <span class="token constant">APP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">isOnline</span><span class="token operator">:</span> <span class="token string">'onLine'</span> <span class="token keyword">in</span> navigator <span class="token operator">&amp;&amp;</span> navigator<span class="token punctuation">.</span>onLine<span class="token punctuation">,</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//then use the online and offline events to change APP.isOnline</span>
    <span class="token comment">//then send a message to the service worker with the new value</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Each script, the main and the Service Worker, should have their own variable that holds a value indicating the online status. Then we use one of the messaging techniques to pass that value between the
two scripts.</p> <p>There are several different ways to send messages from the script to the service worker. These techniques can also be used to send messages between open windows or tabs that belong to the same domain.</p> <p>The <strong>message</strong> that you send between the scripts can be a String, Number, Boolean, null, Array or Object. Basically, anything that you can convert into or from JSON.</p> <h2 id="broadcast-messaging"><a href="#broadcast-messaging" class="header-anchor">#</a> Broadcast Messaging</h2> <p>Broadcast Messaging is like a radio station, which broadcasts on a specific frequency and any other page, tab, or worker from the same domain can listen for messages.</p> <p>In your main script create a <code>BroadcastChannel</code> that you can use to send and receive messages from your script. Your channel object can listen for <code>message</code> events. Your channel object also has a
<code>postMessage()</code> method that will broadcast your message.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//app.js</span>

<span class="token keyword">const</span> <span class="token constant">APP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">channel</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">'wkrp'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//listen for broadcasted messages</span>
    <span class="token constant">APP</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token constant">APP</span><span class="token punctuation">.</span>gotMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">gotMessage</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//this runs when receiving a message</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ev <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//this runs when you need to send a message</span>
    <span class="token comment">//messages can be any object that could be turned into JSON</span>
    <span class="token keyword">let</span> theMessage <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Some information'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token constant">APP</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>theMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Broadcast Messaging can also be useful when you want to keep multiple webpages in sync and you are not using a service worker. In the situation where a user has multiple tabs open to the same website
you can use Broadcast Messaging to tell all the other tabs when something happens on the current tab. Combine this with the <code>Page Visibility API</code> to manage your web app.</p> <div title="Broadcast Messaging API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/n2NeCLTUMTE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="channel-messaging"><a href="#channel-messaging" class="header-anchor">#</a> Channel Messaging</h2> <p><code>Broadcast</code> messaging is sending a message out to anyone who is listening within the browser on the same domain. <code>Channel</code> messaging is a way to create a <strong>pair</strong> of clients that can talk to one
another. For example, a main script and a service worker.</p> <p>This process starts with the main script creating a <code>MessageChannel</code> object.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//app.js</span>

<span class="token keyword">const</span> <span class="token constant">APP</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">channel</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Next you need to access the two <code>port</code> objects inside that <code>MessageChannel</code>. <code>port1</code> is used by the main script to receive messages from the service worker (or other tab|window). <code>port2</code> is sent to
the service worker from the main script with a message direct to the active service worker.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//app.js</span>

<span class="token comment">//after registering the service worker, get the active worker</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//send the port2 to the sw inside the second parameter in an array</span>
  <span class="token comment">//the array will be accessed as a property called `ports`</span>
  reg<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'PORT'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token constant">APP</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//the message object {type:'PORT'} is just an identifier for the service worker</span>
  <span class="token comment">//so it knows it is receiving a port object</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>In the service worker you will receive this message with the standard <code>message</code> event listener and then set up the listener for the port that is passed in.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//sw.js</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log(ev.data);</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'message received in sw'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'PORT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>ports<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//the array from the postMessage() method</span>
    port <span class="token operator">=</span> ev<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">'ports received'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//now add a listener to the port</span>
    port<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> gotMessage<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>The listener in your main script, for incoming messages from the service worker, is put on <code>port1</code>.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//app.js</span>

<span class="token constant">APP</span><span class="token punctuation">.</span>channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token constant">APP</span><span class="token punctuation">.</span>gotMessage<span class="token punctuation">;</span>
<span class="token comment">//gotMessage is our function that listens for messages from the service worker</span>

<span class="token comment">//...</span>

<span class="token function">gotMessage</span><span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>message <span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//message received from service worker</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div> <h2 id="client-messaging"><a href="#client-messaging" class="header-anchor">#</a> Client Messaging</h2> <p>The third way to send messages is by using the <code>postMessage()</code> method of the <code>Client</code> interface. this is actually what we did above to pass the <code>port2</code> object from the main script to the service
worker.</p> <p>Sending messages from the main script to the service worker is just this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//app.js</span>

navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//the messageObj is your object that gets passed to the service worker</span>
  reg<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>messageObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>In the service worker it will be received as a property called <code>data</code> on the message event.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//sw.js</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> messageObj <span class="token operator">=</span> ev<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token comment">//all client messages are received like this</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>To <strong>send</strong> a message using <code>Client</code> messaging is a bit more work.</p> <p>When you have a <code>message</code> event or a <code>fetch</code> event occur in the service worker there should be a property on the event called <code>ev.clientId</code>. This is the identifying id for the client that sent the
message (your main script).</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//works for `message` event too</span>
  <span class="token comment">//after doing other things... if you want to send a message</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ev<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get the client.</span>
    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">await</span> clients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'hello'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//this function will send a message to ONE specific client</span>
  client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>If you want to get the single clientId from the event then the property that you use depends on which event it is. The <code>fetch</code> event has a <code>clientId</code> property. The <code>message</code> event has a <code>source</code>
property that contains an <code>id</code> property with the clientId.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>source<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>The challenging part comes when you want to send a message to ALL the connected clients.</p> <p>It is very possible for a user to have multiple tabs open for the same website. All these tabs will be sharing the same service worker. If you need to keep things in sync across all those tabs, then
it is very likely that you will need to send the same message to all the tabs from the service worker at the same time. Each of those tabs will be running their own copy of the main script. They will
each receive and handle their own copy of the message.</p> <p>But how do we send a message to each of the tabs (clients)?</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//sw.js</span>
<span class="token comment">//send a message to all connected clients</span>
<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//same message being sent to all clients</span>
  <span class="token comment">//clients.matchAll() will find all the clients of this service worker</span>
  clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">clientList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> client <span class="token keyword">of</span> clientList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//loop through each of the clients</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>id<span class="token punctuation">,</span> client<span class="token punctuation">.</span>type<span class="token punctuation">,</span> client<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//id - the unique id for the client</span>
      <span class="token comment">//type - window, worker, or sharedworker</span>
      <span class="token comment">//url - url of the client window</span>
      client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>The <code>clients.matchAll()</code> method can be passed an options object with a <code>type</code> property. The default is <code>{type: 'window'}</code> but you can change it to <code>all</code> or <code>worker</code> or <code>sharedworker</code>.</p> <h2 id="page-visibility-api"><a href="#page-visibility-api" class="header-anchor">#</a> Page Visibility API</h2> <p>As a user switches between tabs or open windows, you can use the <code>Page Visibility API</code> to keep track of when your page comes into focus or loses focus.</p> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API" target="_blank" rel="noopener noreferrer">Page Visibility API reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div title="Page Visibility API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/MxF2WKAGWVk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="fullscreen-api"><a href="#fullscreen-api" class="header-anchor">#</a> FullScreen API</h2> <p>To manage the permissions and toggling in and out of fullscreen mode, you can use the <code>FullScreen API</code>.</p> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API" target="_blank" rel="noopener noreferrer">FullScreen API reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div title="FullScreen API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/aEpQxlKDbwU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <h2 id="screenorientation-api"><a href="#screenorientation-api" class="header-anchor">#</a> ScreenOrientation API</h2> <p>If you need to track the screen orientation - portrait or landscape - then you can use the <code>ScreenOrientation API</code> to listen for the user rotating their device to change the orientation. It can also
be triggered by the user resizing their laptop screen.</p> <p>Do NOT confuse this API with the <code>Device Orientation API</code> which will give you the angle of rotation of the device over the X-axis, Y-axis, and Z-axis.</p> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/ScreenOrientation" target="_blank" rel="noopener noreferrer">Screen Orientation API reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div title="Screen Orientation API" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/FujzCfH7Gzo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Device_orientation_events" target="_blank" rel="noopener noreferrer">Device Orientation API reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="todo-this-week"><a href="#todo-this-week" class="header-anchor">#</a> ToDo This Week</h2> <div class="custom-block danger"><p class="custom-block-title">To Do this week</p> <ul><li>read all the content for modules 6.1 and 6.2</li> <li>Complete the <a href="/w2023/assignments/exer/">Service Worker Assignment</a></li> <li>Start your PWA project</li></ul></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/21/2023, 8:59:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2023/modules/web-components/week5/5.2/" class="prev">
        5.2: PWA Audits, Offline, &amp; Async Methods
      </a></span> <span class="next"><a href="/w2023/modules/web-components/week6/6.2/">
        6.2: PWA Project and Review
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/w2023/assets/js/app.49733bfc.js" defer></script><script src="/w2023/assets/js/2.e00fc094.js" defer></script><script src="/w2023/assets/js/45.90d16594.js" defer></script><script src="/w2023/assets/js/9.b21c66c5.js" defer></script><script src="/w2023/assets/js/11.92cefe25.js" defer></script>
  </body>
</html>
